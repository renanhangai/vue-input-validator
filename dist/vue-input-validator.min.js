!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.VueInputValidator=n()}(this,function(){"use strict";function t(){}function n(){}var e=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(n,e,i){return e&&t(n.prototype,e),i&&t(n,i),n}}(),r={required:function(t){return!!t}},a=function(){function t(){e(this,t)}return i(t,null,[{key:"register",value:function(t,n){r[t]=n}},{key:"validate",value:function(n,e,i){var r={initial:n};return new i.Promise(function(a){a(t._validate(n,e,i,r))}).then(function(t){if(t===!1||null==t)throw new Error("Invalid value");return t===!0?n:t})}},{key:"_validate",value:function(n,e,i,a){if(Array.isArray(e))return t._validateArray(n,e,i,a,0);if("string"==typeof e){e=e.split("|");for(var o=0,s=e.length;o<s;++o)e[o]=e[o].trim();if(e.length>1)return t._validateArray(n,e,i,a,0);var u=r[e];if(null==u)throw new Error('Invalid rule "'+e+'"');return t._validate(n,u,i,a)}if("function"==typeof e)return e.call(null,n,a);throw new Error("Invalid rule")}},{key:"_validateArray",value:function(n,e,i,r,a){return a|=0,i.Promise.resolve(t._validate(n,e[a],i,r)).then(function(o){if(o===!1||null==o)throw new Error("Invalid value");return o===!0&&(o=n),t._validateArray(o,e,i,r,a+1)})}}]),t}(),o=function(){function n(t,i){e(this,n),this.$element=t,this.$parentValidator=i,this.$validation=null,this.$unbind=null,this.onInput=this.onInput.bind(this)}return i(n,[{key:"unbind",value:function(){null!=this.$unbind&&(this.$unbind(),this.$unbind=null)}},{key:"bind",value:function(t,n){var e=this;if(n.componentInstance){if(this.$boundComponent===n.componentInstance)return;this.unbind(),this.$boundComponent=n.componentInstance;var i=n.componentInstance;i.$on("input",this.onInput),this.$unbind=function(){i.$off("input",e.onInput)}}else{if(this.$boundComponent===this.$element)return;this.unbind(),this.$boundComponent=this.$element;var r=this.$element;r.addEventListener("input",this.onInput),this.$unbind=function(){r.removeEventListener("input",e.onInput)}}}},{key:"update",value:function(n,e){this.bind(n,e);var i=null;if(e.componentInstance&&(i=e.componentInstance.name),null==i){i=(this.$element.$el||this.$element).getAttribute("name")}null!=this.$name&&this.$parentValidator.setState(this.$name,null),this.$name=i,this.$validation=n.value,this.validate().then(t,t)}},{key:"onInput",value:function(){var n=this;setTimeout(function(){n.validate(null,"input").then(t,t)},0)}},{key:"validate",value:function(t,n){var e=this;t=t||{};var i=this.$boundComponent&&this.$boundComponent.value||this.$element.value,r=this.$name;this.$id={};var o=this.$id;return this.$parentValidator.setState(r,{dirty:"input"===n?!!i:!!n}),a.validate(i,this.$validation,this.$parentValidator.$options).then(function(n){o===e.$id&&(t.data=t.data||{},t.data[r]=n)},function(n){return o!==e.$id?null:(e.$parentValidator.setState(r,{errors:n}),t.errors=t.errors||{},t.errors[r]=n,Promise.reject(n))})}},{key:"element",get:function(){return this.$element}}]),n}(),s=function(){function t(n,i,r){e(this,t),this.$component=n,this.$parentValidator=i,this.$options=r,this.$childValidators=[],this.$rootValidator=this,this.$parentValidator&&(this.$rootValidator=this.$parentValidator.$rootValidator,this.$parentValidator.$childValidators.push(this)),this._inputElements=[]}return i(t,[{key:"setup",value:function(){this.$options.vue.util.defineReactive(this,"$states",{})}},{key:"bindElement",value:function(t,n,e){for(var i=null,r=0,a=this._inputElements.length;r<a;++r){var s=this._inputElements[r];if(s.$element===t){i=s;break}}i||(i=new o(t,this),this._inputElements.push(i)),i.update(n,e)}},{key:"unbindElement",value:function(t){for(var n=[],e=0,i=this._inputElements.length;e<i;++e){var r=this._inputElements[e];r.$element!==t?n.push(t):r.unbind()}}},{key:"validateAll",value:function(t,e){var i=this;this.$options.vue.set(this,"$states",{}),e=e||{};for(var r=[],a=0,o=this._inputElements.length;a<o;++a)r.push(this._inputElements[a].validate(e,!0).then(n,n));return this.$options.Promise.all(r).then(function(){if(t===!1)return null;for(var r=[],a=0,o=i.$childValidators.length;a<o;++a)r.push(i.$childValidators[a].validateAll(!0,e).then(n,n));return Promise.all(r)}).then(function(){if(e.errors){var t=new Error;throw t.errors=e.errors,t.state=e,t}return e})}},{key:"setState",value:function(t,n){var e=this.$states[t];this.$options.vue.set(this.$states,t,{dirty:e&&e.dirty||n.dirty,errors:n.errors})}},{key:"setPristine",value:function(t){var n=this.$states[t];n&&n.dirty&&this.$options.vue.set(this.$states,t,{dirty:!1,errors:n.errors})}},{key:"hasError",value:function(t){var n=this.$states[t];if(null!=n)return n.dirty&&n.errors;for(var e=0,i=this.$childValidators.length;e<i;++e)if(this.$childValidators[e].hasError(t))return!0;return!1}},{key:"_destroy",value:function(){this.$childValidators=[];for(var t=0,n=this.$parentValidator.$childValidators.length;t<n;++t){if(this.$parentValidator.$childValidators[t]===this){this.$parentValidator.$childValidators.splice(t,1);break}}for(var e=0,i=this._inputElements.length;e<i;++e){this._inputElements[e].unbind()}this._inputElements=[]}}]),t}();return{install:function(t,n){n={vue:t,Promise:n.Promise||Promise},t.directive("validate",{bind:function(t,n,e){e.context.$inputValidator.bindElement(t,n,e)},updated:function(t,n,e){e.context.$inputValidator.bindElement(t,n,e)},unbind:function(t,n,e){e.context.$inputValidator.unbindElement(t)}}),t.mixin({created:function(){var e=null;this.$parent?this.$options.validateScope&&(e=new s(this,this.$parent.$inputValidator,n)):e=new s(this,null,n),null!=e?(t.util.defineReactive(this,"$inputValidator",e),e.setup()):t.util.defineReactive(this,"$inputValidator",this.$parent.$inputValidator)},destroyed:function(){this.hasOwnProperty("$inputValidator")&&(this.$inputValidator._destroy(),delete this.$inputValidator)}})},registerRule:function(t,n){a.register(t,n)}}});