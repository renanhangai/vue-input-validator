!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.VueInputValidator=t()}(this,function(){"use strict";function e(e,t,r,n){var a=r.componentInstance;return a&&a.$props&&a.$props.name?a.$props.name:e.getAttribute("name")}function t(e){return e.target&&null!=e.target.value?e.target.value:e}function r(e,t,r,n){"function"==typeof t.$on?(t.$on(r,n),e.push(function(){t.$off(r,n)})):(t.addEventListener(r,n),e.push(function(){t.removeEventListener(r,n)}))}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=function(){function e(t){a(this,e),this.$setup(t)}return i(e,[{key:"$setup",value:function(e){var t=Object.freeze({options:e||{},errors:{}});Object.defineProperty(this,"$internal",{writable:!1,enumerable:!1,configurable:!1,value:t})}},{key:"$remove",value:function(e){null!=this.$internal.errors[e]&&(this.$internal.errors[e]=null),null!=this[e]&&(this[e]=null)}},{key:"$clear",value:function(e,t){var r=this.$internal.errors[e];if(r&&!(r.length<=0)){var n=[];if(t)for(var a=0,i=r.length;a<i;++a){var s=r[a];t!==s.tag&&n.push(s)}this.$setRaw(e,n)}}},{key:"$update",value:function(t){var r=this.$internal.errors[t],n=void 0;if(!r||r.length<=0)n=!1;else{n=[];for(var a=0,i=r.length;a<i;++a)n.push(e.errorAsString(r[a]));n.first=n[0]}this.$internal.options.vue?this.$internal.options.vue.set(this,t,n):this[t]=n}},{key:"$add",value:function(e,t,r){var n=this[e]||[];n.push({name:e,error:t,tag:r}),this.$setRaw(e,n)}},{key:"$setRaw",value:function(e,t){t&&(t=[].concat(t)),this.$internal.errors[e]=t,this.$update(e)}},{key:"$getRaw",value:function(e){return this.$internal.errors[e]}},{key:"$any",value:function(){for(var e in this.$internal.errors){var t=this.$internal.errors[e];if(t&&t.length>0)return!0}return!1}}],[{key:"errorAsString",value:function(e){return e?"string"==typeof e?e:"string"==typeof e.message?e.message:"Error":""}}]),e}(),o={},u=function(){function n(e,t){a(this,n),t=t||{},this.options=t,this.status={},this.rules={},this.elementsStorage=new(t.WeakMap||WeakMap),t.vue?t.vue.util.defineReactive(this,"errors",new s(t)):this.errors=new s(t)}return i(n,[{key:"bindElement",value:function(n,a,i,s){var u=this,l=i.modifiers.native||!s.componentInstance,c=e(a,i,s,l);if(!c)throw new Error("Missing attribute name on validator");var f=i.arg||"input",v=[],h={name:c,value:i.value,native:l,event:f,unbind:function(){for(var e=0,t=v.length;e<t;++e)v[e].call()}},p=l?a:s.componentInstance;"input"!==f&&r(v,p,"input",function(e){u.errors.$clear(c,o)}),r(v,p,f,function(e){u.setValue(c,t(e))}),this.rules[h.name]={name:h.name,rule:n,autoclean:!!i.modifiers.autoclean},this.elementsStorage.set(a,h)}},{key:"updateElement",value:function(t,r,n,a){var i=this.elementsStorage.get(r);if(!i)return void this.bindElement(t,r,n,a);var s=e(r,n,a,i.native);if(i.name!==s||i.value!==n.value){var o=this.status[i.name],u=this.errors.$getRaw(i.name);this.unbindElement(r),this.bindElement(t,r,n,a),this.status[s]=o,this.errors.$setRaw(s,u)}}},{key:"unbindElement",value:function(e){var t=this.elementsStorage.get(e);if(t){var r=t.name;this.rules[r]=null,this.status[r]=null,this.errors.$remove(r),t.unbind(),this.elementsStorage.delete(e)}}},{key:"setError",value:function(e,t,r){if(this.rules[e]){var n=this.status[e]=this.status[e]||{};n.validationID=null,n.status="error",r&&r.clear===!1&&this.errors.$clear(e,o),this.errors.$add(e,t,t&&t.persistent?null:o)}}},{key:"setValue",value:function(e,t){var r=this,n=this.rules[e];if(!n)return!1;var a=this.status[e]=this.status[e]||{};this.errors.$clear(e,o),a.validationID=null,a.result&&"function"==typeof a.result.cancel&&a.result.cancel();var i=void 0,s=!1;try{i=n.rule(t)}catch(e){i=!1,s=e}if(a.result=i,i&&i.then){var u={};return a.validationID=u,a.status=i.then(function(n){return a.validationID!==u?null:(n===!1?(r.errors.$add(e,!0,o),a.error=!0,a.status="error"):(r.errors.$clear(e,o),a.value=t,a.status="success"),a.status)},function(t){return a.validationID!==u?null:(r.errors.$add(e,t,o),a.error=t,a.status="error",a.status)}),a.status}return i===!1?(this.errors.$add(e,s||!0,o),a.error=s,a.status="error",a.status):(this.errors.$clear(e,o),a.value=t,a.status="success",a.status)}},{key:"validate",value:function(e){var t=this,r=this.options.Promise||Promise,n=[];if(null==e){e=[];for(var a in this.rules)this.rules[a]&&e.push(a)}for(var i=0,s=e.length;i<s;++i){var o=e[i];if(!this.rules[o])throw new Error('Unknown field "'+o+'"');var u=this.status[o]=this.status[o]||{},l=this.setValue(o,u.value||"");l&&l.then&&n.push(l)}return r.all(n).then(function(){var e={},n={},a=!1;for(var i in t.rules){if(t.rules[i]){var s=t.status[i]=t.status[i]||{};"success"!==s.status?(e[i]=t.errors[i],a=!0):n[i]=s.value}}return a?r.reject(e):n})}}]),n}();Object.defineProperty(u,"INPUT_TAG",{writable:!1,configurable:!1,value:o});var l=function(){function e(){a(this,e),this.rules={}}return i(e,[{key:"register",value:function(e,t){this.rules[e]={name:e,rule:t}}},{key:"getCallback",value:function(e){var t=this.rules[e];if(!t)throw new Error('Invalid rule "'+e+'"');return t.rule}},{key:"parse",value:function(e){var t=this.parseInternal(e);return this.makeCallbackChain(t)}},{key:"parseInternal",value:function(e){var t=[];if("string"==typeof e)t=t.concat(this.parseInternalString(e));else if(Array.isArray(e))for(var r=0,n=e.length;r<n;++r)t=t.concat(this.parseInternal(e));else{if("function"!=typeof e)throw new Error("Invalid rule to parse: "+e);t.push({callback:e})}return t}},{key:"parseInternalString",value:function(e){for(var t=e.split("|"),r=[],n=0,a=t.length;n<a;++n){var i=t[n].split(":"),s=i.shift();r.push({args:i,callback:this.getCallback(s)})}return r}},{key:"makeCallbackChain",value:function(e){if(!e||e.length<=0)return!1;var t=function t(r,n){if(n.cancelled)return!1;for(;n.i<e.length;){var a=e[n.i],i=a.args||[],s=a.callback.apply(null,[r].concat(i));if(n.current=s,s===!1)return!1;if(s&&s.then)return s.then(function(){return n.i+=1,t(r,n)});++n.i}return!0};return t.cancel=function(e){e.cancelled||(e.cancelled=!0,e.current&&"function"==typeof e.current.cancel&&e.current.cancel())},function(e){var r={cancelled:!1,i:0},a=t(e,r);return"object"===(void 0===a?"undefined":n(a))&&(a.cancel=function(){t.cancel(r)}),a}}}]),e}(),c=new l;return{registerRule:function(e,t){c.register(e,t)},install:function(e,t){t=t||{};var r=t.directive||"validate";e.directive(r,{bind:function(e,t,r){var n=r.context.$validator;if(!r.context.$validatorOwn)throw new Error("Invalid validator context.\nDid you set validate: true on the root context component? "+r.context.name);var a=c.parse(t.value);n.bindElement(a,e,t,r)},update:function(e,t,r){var n=r.context.$validator,a=c.parse(t.value);n.updateElement(a,e,t,r)},unbind:function(e,t,r){r.context.$validator.unbindElement(e,t,r)}}),Object.defineProperty(e.prototype,"$validator",{get:function(){var r=null;if(this.$options.validate===!0){r=new u(this.$parent?this.$parent.$validator:null,{vue:e,Promise:t.Promise})}else if("inherit"===this.$options.validate&&!(r=this.$parent?this.$parent.$validator:null))throw new Error("Invalid parent validator to inherit");return r?(Object.defineProperty(this,"$validator",{value:r}),Object.defineProperty(this,"$validatorOwn",{value:!0}),r):this.$parent&&this.$parent.$validator}}),Object.defineProperty(e.prototype,"$errors",{get:function(){return this.$validator.errors}})}}});