!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.VueInputValidator=n()}(this,function(){"use strict";function t(t){for(var n=0,e=t.length;n<e;++n)t[n]=t[n].trim();return t}function n(){}function e(){}var i=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},r=function(){function t(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(n,e,i){return e&&t(n.prototype,e),i&&t(n,i),n}}(),a={required:function(t){return!!t}},o=function(){function n(){i(this,n)}return r(n,null,[{key:"register",value:function(t,n){a[t]=n}},{key:"validate",value:function(t,e,i){var r={initial:t};return new i.Promise(function(a){a(n._validate(t,e,i,r))}).then(function(n){if(n===!1)throw new Error("Invalid value");return n===!0||null==n?t:n})}},{key:"_validate",value:function(e,i,r,o,s){if(Array.isArray(i))return n._validateArray(e,i,r,o,{},0);if("string"==typeof i){if(i=t(i.split("|")),i.length>1)return n._validateArray(e,i,r,o,{},0);i=i[0];var u=t(i.split(":")),l=a[u[0]];if(null==l)throw new Error('Invalid rule "'+i+'"');return n._validate(e,l,r,o,{args:u.slice(1)})}if("function"==typeof i){var h=[e].concat(s&&s.args||[]);return i.apply(null,h)}throw new Error("Invalid rule")}},{key:"_validateArray",value:function(t,e,i,r,a,o){return o|=0,o>=e.length?t:i.Promise.resolve(n._validate(t,e[o],i,r,a)).then(function(s){if(s===!1)throw new Error("Invalid value");return s!==!0&&null!=s||(s=t),n._validateArray(s,e,i,r,a,o+1)})}}]),n}(),s=function(){function t(n,e){i(this,t),this.$element=n,this.$parentValidator=e,this.$validation=null,this.$unbind=null,this.onInput=this.onInput.bind(this)}return r(t,[{key:"unbind",value:function(){null!=this.$unbind&&(this.$unbind(),this.$unbind=null)}},{key:"bind",value:function(t,n){var e=this;if(n.componentInstance){if(this.$boundComponent===n.componentInstance)return;this.unbind(),this.$boundComponent=n.componentInstance;var i=n.componentInstance;i.$on("input",this.onInput),this.$unbind=function(){i.$off("input",e.onInput)}}else{if(this.$boundComponent===this.$element)return;this.unbind(),this.$boundComponent=this.$element;var r=this.$element;r.addEventListener("input",this.onInput),this.$unbind=function(){r.removeEventListener("input",e.onInput)}}}},{key:"update",value:function(t,e){this.bind(t,e);var i=null;if(e.componentInstance&&(i=e.componentInstance.name),null==i){i=(this.$element.$el||this.$element).getAttribute("name")}null!=this.$name&&this.$parentValidator.setState(this.$name,null),this.$name=i,this.$validation=t.value,this.validate().then(n,n)}},{key:"onInput",value:function(){var t=this;setTimeout(function(){t.validate(null,"input").then(n,n)},0)}},{key:"validate",value:function(t,n){var e=this;t=t||{};var i=this.$boundComponent&&this.$boundComponent.value||this.$element.value,r=this.$name;this.$id={};var a=this.$id;return this.$parentValidator.setState(r,{dirty:"input"===n?!!i:!!n}),o.validate(i,this.$validation,this.$parentValidator.$options).then(function(n){a===e.$id&&(t.data=t.data||{},t.data[r]=n)},function(n){return a!==e.$id?null:(e.$parentValidator.setState(r,{errors:n}),t.errors=t.errors||{},t.errors[r]=n,Promise.reject(n))})}},{key:"element",get:function(){return this.$element}}]),t}(),u=function(){function t(n,e,r){i(this,t),this.$component=n,this.$parentValidator=e,this.$options=r,this.$childValidators=[],this.$rootValidator=this,this.$parentValidator&&(this.$rootValidator=this.$parentValidator.$rootValidator,this.$parentValidator.$childValidators.push(this)),this._inputElements=[]}return r(t,[{key:"setup",value:function(){this.$options.vue.util.defineReactive(this,"$states",{})}},{key:"bindElement",value:function(t,n,e){for(var i=null,r=0,a=this._inputElements.length;r<a;++r){var o=this._inputElements[r];if(o.$element===t){i=o;break}}i||(i=new s(t,this),this._inputElements.push(i)),i.update(n,e)}},{key:"unbindElement",value:function(t){for(var n=[],e=0,i=this._inputElements.length;e<i;++e){var r=this._inputElements[e];r.$element!==t?n.push(t):r.unbind()}}},{key:"validateAll",value:function(t,n){var i=this;this.$options.vue.set(this,"$states",{}),n=n||{};for(var r=[],a=0,o=this._inputElements.length;a<o;++a)r.push(this._inputElements[a].validate(n,!0).then(e,e));return this.$options.Promise.all(r).then(function(){if(t===!1)return null;for(var r=[],a=0,o=i.$childValidators.length;a<o;++a)r.push(i.$childValidators[a].validateAll(!0,n).then(e,e));return Promise.all(r)}).then(function(){if(n.errors){var t=new Error;throw t.errors=n.errors,t.state=n,t}return n})}},{key:"setState",value:function(t,n){var e=this.$states[t];this.$options.vue.set(this.$states,t,{dirty:e&&e.dirty||n.dirty,errors:n.errors})}},{key:"setPristine",value:function(t){var n=this.$states[t];n&&n.dirty&&this.$options.vue.set(this.$states,t,{dirty:!1,errors:n.errors})}},{key:"hasError",value:function(t){var n=this.$states[t];if(null!=n)return n.dirty&&n.errors;for(var e=0,i=this.$childValidators.length;e<i;++e)if(this.$childValidators[e].hasError(t))return!0;return!1}},{key:"_destroy",value:function(){this.$childValidators=[];for(var t=0,n=this.$parentValidator.$childValidators.length;t<n;++t){if(this.$parentValidator.$childValidators[t]===this){this.$parentValidator.$childValidators.splice(t,1);break}}for(var e=0,i=this._inputElements.length;e<i;++e){this._inputElements[e].unbind()}this._inputElements=[]}}]),t}();return{install:function(t,n){n={vue:t,Promise:n.Promise||Promise},t.directive("validate",{bind:function(t,n,e){e.context.$inputValidator.bindElement(t,n,e)},updated:function(t,n,e){e.context.$inputValidator.bindElement(t,n,e)},unbind:function(t,n,e){e.context.$inputValidator.unbindElement(t)}}),t.mixin({created:function(){var e=null;this.$parent?this.$options.validateScope&&(e=new u(this,this.$parent.$inputValidator,n)):e=new u(this,null,n),null!=e?(t.util.defineReactive(this,"$inputValidator",e),e.setup()):t.util.defineReactive(this,"$inputValidator",this.$parent.$inputValidator)},destroyed:function(){this.hasOwnProperty("$inputValidator")&&(this.$inputValidator._destroy(),delete this.$inputValidator)}})},registerRule:function(t,n){o.register(t,n)}}});