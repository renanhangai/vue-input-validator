!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.VueInputValidator=e()}(this,function(){"use strict";function t(t,e,r,n){var i=r.componentInstance;return i&&i.$props&&i.$props.name?i.$props.name:t.getAttribute("name")}function e(t){return t.target&&null!=t.target.value?t.target.value:t}function r(t,e,r,n){"function"==typeof e.$on?(e.$on(r,n),t.push(function(){e.$off(r,n)})):(e.addEventListener(r,n),t.push(function(){e.removeEventListener(r,n)}))}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},a=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),s=function(){function t(e){i(this,t),this.$setup(e)}return a(t,[{key:"$setup",value:function(t){var e=Object.freeze({options:t||{},errors:{}});Object.defineProperty(this,"$internal",{writable:!1,enumerable:!1,configurable:!1,value:e})}},{key:"$remove",value:function(t){null!=this.$internal.errors[t]&&(this.$internal.errors[t]=null),null!=this[t]&&(this[t]=null)}},{key:"$clear",value:function(t,e){var r=this.$internal.errors[t];if(r&&!(r.length<=0)){var n=[];if(e)for(var i=0,a=r.length;i<a;++i){var s=r[i];e!==s.tag&&n.push(s)}this.$setRaw(t,n)}}},{key:"$update",value:function(e){var r=this.$internal.errors[e],n=void 0;if(!r||r.length<=0)n=!1;else{n=[];for(var i=0,a=r.length;i<a;++i)n.push(t.errorAsString(r[i]));n.first=n[0]}this.$internal.options.vue?this.$internal.options.vue.set(this,e,n):this[e]=n}},{key:"$add",value:function(t,e,r){var n=this[t]||[];n.push({name:t,error:e,tag:r}),this.$setRaw(t,n)}},{key:"$setRaw",value:function(t,e){e&&(e=[].concat(e)),this.$internal.errors[t]=e,this.$update(t)}},{key:"$getRaw",value:function(t){return this.$internal.errors[t]}},{key:"$any",value:function(){for(var t in this.$internal.errors){var e=this.$internal.errors[t];if(e&&e.length>0)return!0}return!1}}],[{key:"errorAsString",value:function(t){return t?"string"==typeof t?t:"string"==typeof t.message?t.message:"Error":""}}]),t}(),u={},o=function(){function n(t,e){i(this,n),e=e||{},this.options=e,this.status={},this.rules={},this.elementsStorage=new(e.WeakMap||WeakMap),e.vue?e.vue.util.defineReactive(this,"errors",new s(e)):this.errors=new s(e)}return a(n,[{key:"setPristine",value:function(t){if(null==t)for(var e in this.status)this.status[e].dirty=!1;else for(var r=0,n=t.length;r<n;++r){var i=t[r],a=this.status[i];a&&(a.dirty=!1)}}},{key:"clear",value:function(t){if(null==t)for(var e in this.status)this.status[e]={},this.errors.$clear(e,u);else for(var r=0,n=t.length;r<n;++r){var i=t[r];this.status[i]={},this.errors.$clear(i,u)}}},{key:"bindElement",value:function(n,i,a,s){var o=this,l=a.modifiers.native||!s.componentInstance,c=t(i,a,s,l);if(!c)throw new Error("Missing attribute name on validator");var f=a.arg||"input",v=[],h={name:c,value:a.value,native:l,event:f,unbind:function(){for(var t=0,e=v.length;t<e;++t)v[t].call()}},p=l?i:s.componentInstance;"input"!==f&&r(v,p,"input",function(t){o.errors.$clear(c,u)}),r(v,p,f,function(t){o.setValue(c,e(t),!0)});var d=this.rules[h.name]={name:h.name,rule:n,optional:!!a.modifiers.optional,dirty:!!a.modifiers.dirty};if(this.elementsStorage.set(i,h),d.dirty){(this.status[c]=this.status[c]||{}).dirty=!0}}},{key:"updateElement",value:function(e,r,n,i){var a=this.elementsStorage.get(r);if(!a)return void this.bindElement(e,r,n,i);var s=t(r,n,i,a.native);if(a.name!==s||a.value!==n.value){var u=this.status[a.name],o=this.errors.$getRaw(a.name);this.unbindElement(r),this.bindElement(e,r,n,i),this.status[s]=u,this.errors.$setRaw(s,o)}}},{key:"unbindElement",value:function(t){var e=this.elementsStorage.get(t);if(e){var r=e.name;this.rules[r]=null,this.status[r]=null,this.errors.$remove(r),e.unbind(),this.elementsStorage.delete(t)}}},{key:"setError",value:function(t,e,r){if(this.rules[t]){var n=this.status[t]=this.status[t]||{};n.validationID=null,n.status="error",r&&r.clear===!1&&this.errors.$clear(t,u),this.errors.$add(t,e,e&&e.persistent?null:u)}}},{key:"setValue",value:function(t,e,r){var n=this,i=this.status[t]=this.status[t]||{};if(!i.dirty&&!e&&r)return!1;i.dirty=!0;var a=function(e){return n.errors.$clear(t,u),i.value=e,i.status="success",i.result=null,i.status},s=function(e){return e=e||!0,n.errors.$add(t,e,u),i.error=e,i.status="error",i.result=null,i.status},o=this.rules[t];if(!o)return!1;if(this.errors.$clear(t,u),i.validationID=null,i.result&&"function"==typeof i.result.cancel&&i.result.cancel(),!e&&o.optional)return a("");var l=void 0,c=!1;try{l=o.rule(e)}catch(t){l=!1,c=t}if(i.result=l,l&&l.then){var f={};return i.validationID=f,i.status=l.then(function(t){return i.validationID!==f?null:t===!1?s():a(e)},function(t){return i.validationID!==f?null:s(t)}),i.status}return l===!1?s(c):a(e)}},{key:"validate",value:function(t){var e=this,r=this.options.Promise||Promise,n=[];if(null==t){t=[];for(var i in this.rules)this.rules[i]&&t.push(i)}for(var a=0,s=t.length;a<s;++a){var u=t[a];if(!this.rules[u])throw new Error('Unknown field "'+u+'"');var o=this.status[u]=this.status[u]||{},l=this.setValue(u,o.value||"");l&&l.then&&n.push(l)}return r.all(n).then(function(){var t={},n={},i=!1;for(var a in e.rules){if(e.rules[a]){var s=e.status[a]=e.status[a]||{};"success"!==s.status?(t[a]=e.errors[a],i=!0):n[a]=s.value}}return i?r.reject(t):n})}}]),n}();Object.defineProperty(o,"INPUT_TAG",{writable:!1,configurable:!1,value:u});var l=function(){function t(){i(this,t),this.rules={}}return a(t,[{key:"register",value:function(t,e){this.rules[t]={name:t,rule:e}}},{key:"getCallback",value:function(t){var e=this.rules[t];if(!e)throw new Error('Invalid rule "'+t+'"');return e.rule}},{key:"parse",value:function(t){var e=this.parseInternal(t);return this.makeCallbackChain(e)}},{key:"parseInternal",value:function(t){var e=[];if("string"==typeof t)e=e.concat(this.parseInternalString(t));else if(Array.isArray(t))for(var r=0,n=t.length;r<n;++r)e=e.concat(this.parseInternal(t));else{if("function"!=typeof t)throw new Error("Invalid rule to parse: "+t);e.push({callback:t})}return e}},{key:"parseInternalString",value:function(t){for(var e=t.split("|"),r=[],n=0,i=e.length;n<i;++n){var a=e[n].split(":"),s=a.shift();r.push({args:a,callback:this.getCallback(s)})}return r}},{key:"makeCallbackChain",value:function(t){if(!t||t.length<=0)return!1;var e=function e(r,n){if(n.cancelled)return!1;for(;n.i<t.length;){var i=t[n.i],a=i.args||[],s=i.callback.apply(null,[r].concat(a));if(n.current=s,s===!1)return!1;if(s&&s.then)return s.then(function(){return n.i+=1,e(r,n)});++n.i}return!0};return e.cancel=function(t){t.cancelled||(t.cancelled=!0,t.current&&"function"==typeof t.current.cancel&&t.current.cancel())},function(t){var r={cancelled:!1,i:0},i=e(t,r);return"object"===(void 0===i?"undefined":n(i))&&(i.cancel=function(){e.cancel(r)}),i}}}]),t}(),c=new l;return{registerRule:function(t,e){c.register(t,e)},install:function(t,e){e=e||{};var r=e.directive||"validate";t.directive(r,{bind:function(t,e,r){var n=r.context.$validator;if(!r.context.$validatorOwn)throw new Error("Invalid validator context.\nDid you set validate: true on the root context component? "+r.context.name);var i=c.parse(e.value);n.bindElement(i,t,e,r)},update:function(t,e,r){var n=r.context.$validator,i=c.parse(e.value);n.updateElement(i,t,e,r)},unbind:function(t,e,r){r.context.$validator.unbindElement(t,e,r)}}),Object.defineProperty(t.prototype,"$validator",{get:function(){var r=null;if(this.$options.validate===!0){r=new o(this.$parent?this.$parent.$validator:null,{vue:t,Promise:e.Promise})}else if("inherit"===this.$options.validate&&!(r=this.$parent?this.$parent.$validator:null))throw new Error("Invalid parent validator to inherit");return r?(Object.defineProperty(this,"$validator",{value:r}),Object.defineProperty(this,"$validatorOwn",{value:!0}),r):this.$parent&&this.$parent.$validator}}),Object.defineProperty(t.prototype,"$errors",{get:function(){return this.$validator.errors}})}}});